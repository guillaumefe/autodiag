<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Caty Health Tracker</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { height: 100%; font-family: Arial, sans-serif; }
    .splash-container { width: 100%; height: 100%; background: linear-gradient(to bottom, #ff9a8b, #ff6f61); display: flex; justify-content: center; align-items: center; flex-direction: column; position: fixed; top: 0; left: 0; z-index: 1000; overflow: hidden; }
    .brand { font-size: 4em; font-weight: bold; color: white; text-shadow: 2px 2px 10px rgba(0,0,0,0.5); opacity: 0; animation: fall 2s ease-in-out forwards; }
    @keyframes fall { 0% { transform: translateY(-100vh); opacity: 0; } 50% { transform: translateY(0); opacity: 1; } 70% { transform: translateY(-20px); } 100% { transform: translateY(0); } }
    .fade-out { animation: fadeOut 1s forwards; }
    @keyframes fadeOut { 0% { opacity: 1; } 100% { opacity: 0; visibility: hidden; } }
    .app-container { display: none; flex: 1; flex-direction: column; height: 100%; }
    header { background-color: #ff6f61; color: white; text-align: center; padding: 1em; font-size: 1.5em; display: flex; justify-content: space-between; align-items: center; }
    nav { display: flex; justify-content: space-between; align-items: center; padding: 1em; background-color: #f3f3f3; flex-wrap: wrap; }
    nav select, nav button { padding: 0.5em; border-radius: 5px; border: 1px solid #ddd; cursor: pointer; margin: 0.5em 0; }
    nav .nav-buttons { display: flex; flex-wrap: wrap; gap: 0.5em; }
    main { display: flex; flex: 1; overflow-y: hidden; padding: 1em; flex-direction: row; }
    .main-content { flex-grow: 1; overflow-y: auto; padding: 1em; background-color: #f9f9f9; display: flex; flex-direction: column; gap: 2em; }
    .chart-container, .quiz-container, .chat-container, .calendar-container, .summary-chart-container { background: white; padding: 1em; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .chart-container canvas, .summary-chart-container canvas { width: 100%; height: 300px; }
    .chat-container { display: flex; flex-direction: column; height: 400px; }
    .connected-users { margin-bottom: 1em; }
    .connected-users h3 { margin-bottom: 0.5em; }
    .connected-users ul { list-style: none; max-height: 100px; overflow-y: auto; }
    .connected-users li { margin-bottom: 0.3em; display: flex; justify-content: space-between; align-items: center; }
    .connected-users button { margin-left: 0.5em; padding: 0.2em 0.5em; border: none; background-color: #4caf50; color: white; border-radius: 3px; cursor: pointer; }
    .messages { height: 55%; flex-grow: 1; overflow-y: auto; border: 1px solid #ccc; padding: 0.5em; margin-bottom: 0.5em; border-radius: 5px; background-color: #fff; }
    .message { margin-bottom: 0.5em; display: flex; }
    .message.user { justify-content: flex-end; }
    .message .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #bbb; margin-right: 0.5em; }
    .message.user .avatar { margin-left: 0.5em; margin-right: 0; }
    .message .text { max-width: 60%; padding: 0.5em 1em; border-radius: 20px; background-color: #fff; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .message.user .text { background-color: #dcf8c6; }
    .message .text::after { content: ""; position: absolute; top: 10px; width: 0; height: 0; border: 10px solid transparent; }
    .message.user .text::after { right: -20px; border-left-color: #dcf8c6; }
    .message .text::after { left: -20px; border-right-color: #fff; }
    .chat-input { display: flex; gap: 0.5em; }
    .chat-input input { flex-grow: 1; padding: 0.5em; border: 1px solid #ccc; border-radius: 5px; }
    .chat-input button { padding: 0.5em 1em; border: none; background-color: #76c7c0; color: white; cursor: pointer; border-radius: 5px; }
    .voice-buttons { display: flex; justify-content: space-between; margin-top: 0.5em; }
    .voice-buttons button { padding: 0.5em; border: none; background-color: #2196f3; color: white; cursor: pointer; border-radius: 5px; flex: 1; margin: 0 0.25em; }
    footer { background-color: #ff6f61; color: white; text-align: center; padding: 0.5em; flex-shrink: 0; }
    .logs-container { width: 100%; max-width: 300px; background-color: #333; color: #fff; display: none; flex-direction: column; padding: 1em; overflow-y: auto; position: relative; }
    @media (min-width: 768px) { .logs-container { width: 30%; max-width: none; } }
    .logs-container h3 { margin-bottom: 1em; }
    .log-entry { font-size: 0.9em; margin-bottom: 0.5em; padding: 0.5em; border-radius: 5px; }
    .log-entry.info { background-color: #2196f3; }
    .log-entry.warning { background-color: #ff9800; }
    .log-entry.error { background-color: #f44336; }
    .toggle-logs-btn { position: absolute; top: 10px; right: -40px; background-color: #333; color: #fff; border: none; padding: 0.5em; cursor: pointer; border-radius: 5px 0 0 5px; transform: rotate(-90deg); transform-origin: top right; font-size: 0.9em; }
    @media (max-width: 767px) { .logs-container { position: fixed; bottom: 0; right: 0; width: 100%; max-width: none; height: 200px; } .toggle-logs-btn { right: 10px; top: -40px; transform: rotate(0); } }
    .modal, .manage-questions-modal, .event-modal, .tutorial-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1001; }
    .modal-content, .manage-questions-modal-content, .event-modal-content, .tutorial-modal-content { background: white; padding: 2em; border-radius: 10px; width: 90%; max-width: 600px; text-align: center; display: flex; flex-direction: column; gap: 1em; position: relative; }
    .modal-content label, .event-modal-content label { align-self: flex-start; }
    .modal-content input, .modal-content select, .modal-content button, .modal-content textarea, .event-modal-content input, .event-modal-content textarea { margin: 0.5em 0; padding: 0.5em; width: 100%; }
    .manage-questions-modal-content { max-height: 80vh; overflow-y: auto; }
    .toggle-password { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer; }
    .calendar-container { background-color: white; padding: 1em; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #ccc; margin-bottom: 1em; }
    .calendar-day { background-color: #fff; padding: 10px; border: 1px solid #ddd; min-height: 80px; position: relative; cursor: pointer; display: flex; align-items: flex-start; justify-content: flex-start; flex-direction: column; }
    .calendar-day.has-event { background-color: #ffeb3b; }
    .calendar-day:hover .tooltip { display: block; }
    .tooltip { display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); background-color: #333; color: #fff; padding: 5px; border-radius: 3px; white-space: nowrap; z-index: 10; }
    .upcoming-events h3 { margin-bottom: 0.5em; }
    .upcoming-events ul { list-style: none; padding: 0; }
    .upcoming-events li { margin-bottom: 0.5em; }
    .slider-container { display: flex; flex-direction: column; margin-bottom: 1em; }
    .slider-container label { margin-bottom: 0.5em; }
    .slider-input { display: flex; align-items: center; }
    .slider-input input[type="range"] { flex-grow: 1; }
    .slider-value { width: 50px; text-align: center; font-weight: bold; margin-left: 0.5em; }
    .slider-value.good { color: green; }
    .slider-value.warning { color: orange; }
    .slider-value.bad { color: red; }
    .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider-switch { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.4s; border-radius: 24px; }
    .slider-switch:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: 0.4s; border-radius: 50%; }
    input:checked + .slider-switch { background-color: #2196F3; }
    input:checked + .slider-switch:before { transform: translateX(26px); }
    .question-list { text-align: left; }
    .question-list h3 { margin-bottom: 0.5em; }
    .question-list ul { list-style: none; padding: 0; }
    .question-list li { padding: 0.5em; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; }
    .question-list li:last-child { border-bottom: none; }
    .question-actions button { margin-left: 0.5em; padding: 0.3em 0.6em; border: none; background-color: #2196F3; color: white; border-radius: 3px; cursor: pointer; }
    @media (max-width: 767px) { header { flex-direction: column; } nav { flex-direction: column; } .nav-buttons { flex-direction: column; width: 100%; } .logs-container { position: fixed; bottom: 0; right: 0; width: 100%; max-width: none; height: 200px; } .toggle-logs-btn { right: 10px; top: -40px; transform: rotate(0); } }
    </style>
</head>
<body>
  <div class="splash-container" id="splash">
    <div class="brand">Caty</div>
  </div>
  <div class="app-container" id="app">
    <header>
      <span data-key="appTitle">Caty Health Tracker</span>
      <select id="languageSelector" class="language-selector" onchange="changeLanguage(this.value)">
        <option value="" disabled selected>Select Language</option>
        <option value="en">EN</option>
        <option value="fr">FR</option>
      </select>
    </header>
    <nav>
      <select id="chatSelector" onchange="selectChat()">
        <option value="" disabled selected>Select Chat</option>
      </select>
      <div class="nav-buttons">
        <button onclick="createChat()">Create Chat</button>
        <button onclick="shareChat()">Share Chat</button>
        <button onclick="exportChatExcel()">Export Chat Excel</button>
        <button onclick="deleteChat()" id="deleteChatBtn" style="display:none;">Delete Chat</button>
        <button onclick="openManageQuestionsModal()" id="manageQuestions" style="display:none;">Manage Questions</button>
        <button onclick="logout()" style="display:none;" id="logoutBtn">Logout</button>
      </div>
    </nav>
    <main>
      <div class="main-content">
        <section class="chart-container" id="chartsSection" style="display:none;">
          <h2 data-key="realTimeRadar">Real-Time Health Radar</h2>
          <canvas id="realtimeRadar"></canvas>
        </section>
        <section class="quiz-container" id="quizSection" style="display:none;">
          <h2 data-key="dailyHealthChecklist">Daily Health Checklist</h2>
          <form id="quizForm"></form>
          <button onclick="saveAnswers()">Save</button>
        </section>
        <section class="chart-container" id="timeSeriesSection" style="display:none;">
          <h2 data-key="healthMetrics">Health Metrics Over Time</h2>
          <canvas id="timeSeriesChart"></canvas>
        </section>
        <section class="summary-chart-container" id="summaryChartSection" style="display:none;">
          <h2>Summary Radar Over Time</h2>
          <canvas id="summaryRadarChart"></canvas>
        </section>
        <section class="chat-container" id="chatSection" style="display:none;">
          <h2>Chat</h2>
          <div class="connected-users">
            <h3>Connected Users:</h3>
            <ul id="usersList"></ul>
          </div>
          <div class="messages" id="messages"></div>
          <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Type a message">
            <button onclick="sendMessage()">Send</button>
          </div>
          <div class="voice-buttons">
            <button id="recordButton" onclick="toggleRecording()">Start Recording</button>
            <button id="stopRecordButton" onclick="stopRecording()" style="display:none;">Stop</button>
            <button id="sendVoiceButton" onclick="sendVoice()" style="display:none;">Publish</button>
            <button id="reRecordButton" onclick="reRecordVoice()" style="display:none;">Re-record</button>
          </div>
        </section>
        <section class="calendar-container" id="calendarSection" style="display:none;">
          <h2>Shared Calendar</h2>
          <div class="calendar" id="calendar"></div>
          <div class="upcoming-events">
            <h3>Upcoming Events (Next 15 Days)</h3>
            <ul id="upcomingEventsList"></ul>
          </div>
          <button onclick="showAddEventModal()">Add Event</button>
        </section>
      </div>
      <div class="logs-container" id="logsContainer">
        <button class="toggle-logs-btn" onclick="toggleLogs()">Logs</button>
        <h3>Logs</h3>
        <div id="logs"></div>
      </div>
    </main>
    <footer>Made with ❤️ for your beloved cats</footer>
  </div>
  <div class="modal" id="languageModal">
    <div class="modal-content">
      <h2>Select Language</h2>
      <select id="initialLanguageSelector">
        <option value="en">English</option>
        <option value="fr">Français</option>
      </select>
      <button onclick="submitLanguage()">Submit</button>
    </div>
  </div>
  <div class="modal" id="firebaseConfigModal">
    <div class="modal-content">
      <h2>Configure Firebase</h2>
      <label for="apiKey">API Key:</label>
      <input type="text" id="apiKey" placeholder="Enter API Key">
      <label for="authDomain">Auth Domain:</label>
      <input type="text" id="authDomain" placeholder="Enter Auth Domain">
      <label for="databaseURL">Database URL:</label>
      <input type="text" id="databaseURL" placeholder="Enter Database URL">
      <label for="projectId">Project ID:</label>
      <input type="text" id="projectId" placeholder="Enter Project ID">
      <label for="storageBucket">Storage Bucket:</label>
      <input type="text" id="storageBucket" placeholder="Enter Storage Bucket">
      <label for="messagingSenderId">Messaging Sender ID:</label>
      <input type="text" id="messagingSenderId" placeholder="Enter Messaging Sender ID">
      <label for="appId">App ID:</label>
      <input type="text" id="appId" placeholder="Enter App ID">
      <button onclick="submitFirebaseConfig()">Submit</button>
    </div>
  </div>
  <div class="modal" id="authModal">
    <div class="modal-content">
      <h2 id="authTitle">Login</h2>
      <input type="email" id="authEmail" placeholder="Email">
      <div class="password-container">
        <input type="password" id="authPassword" placeholder="Password">
        <span class="toggle-password" onclick="togglePasswordVisibility('authPassword')">👁️</span>
      </div>
      <button onclick="authenticate()">Login</button>
      <button onclick="toggleAuthMode()">Sign Up</button>
      <button onclick="closeModal('authModal')">Close</button>
    </div>
  </div>
  <div class="modal" id="linkChatModal">
    <div class="modal-content">
      <h2>Link to Existing Chat</h2>
      <input type="text" id="linkChatCode" placeholder="Enter Chat Code">
      <button onclick="linkExistingChat()">Link Chat</button>
      <button onclick="closeModal('linkChatModal')">Close</button>
    </div>
  </div>
  <div class="modal" id="tutorialModal">
    <div class="modal-content">
      <h2 id="tutorialTitle"></h2>
      <p id="tutorialText"></p>
      <button onclick="nextTutorialStep()">Next</button>
      <button onclick="closeModal('tutorialModal')">Close</button>
    </div>
  </div>
  <div class="modal" id="deleteChatModal">
    <div class="modal-content">
      <h2>Delete Chat</h2>
      <p>Please type the chat name to confirm deletion:</p>
      <input type="text" id="confirmChatName" placeholder="Enter Chat Name">
      <button onclick="confirmDeleteChat()">Delete</button>
      <button onclick="closeModal('deleteChatModal')">Close</button>
      <span id="deleteError" style="color: red; display: none;">Chat name does not match.</span>
    </div>
  </div>
  <div class="modal" id="addEventModal">
    <div class="modal-content">
      <h2>Add Event</h2>
      <input type="text" id="eventTitle" placeholder="Event Title">
      <input type="datetime-local" id="eventDateTime">
      <textarea id="eventDescription" placeholder="Event Description"></textarea>
      <button onclick="addEvent()">Add</button>
      <button onclick="closeModal('addEventModal')">Cancel</button>
    </div>
  </div>
  <div class="modal" id="editEventModal">
    <div class="event-modal-content">
      <h2>Éditer l'Événement</h2>
      <label for="editEventTitle">Titre de l'Événement :</label>
      <input type="text" id="editEventTitle" placeholder="Entrez le titre de l'événement">
      <label for="editEventDateTime">Date et Heure de l'Événement :</label>
      <input type="datetime-local" id="editEventDateTime">
      <label for="editEventDescription">Description de l'Événement :</label>
      <textarea id="editEventDescription" placeholder="Entrez la description de l'événement"></textarea>
      <div class="modal-buttons">
        <button onclick="saveEditedEvent()">Sauvegarder</button>
        <button onclick="closeModal('editEventModal')">Annuler</button>
      </div>
    </div>
  </div>
  <div class="modal" id="manageQuestionsModal">
    <div class="modal-content">
      <h2>Manage Questions</h2>
      <button onclick="addQuestion()">Add Question</button>
      <div class="question-list">
        <h3>Current Questions:</h3>
        <ul id="questionsList"></ul>
      </div>
      <button onclick="closeModal('manageQuestionsModal')">Close</button>
    </div>
  </div>
  <script>
    const languages = {
      en: { appTitle: "Caty Health Tracker", realTimeRadar: "Real-Time Health Radar", dailyHealthChecklist: "Daily Health Checklist", healthMetrics: "Health Metrics Over Time", summaryRadar: "Summary Radar Over Time", save: "Save", send: "Send", recordVoice: "Start Recording", stopVoice: "Stop", sendVoice: "Publish", reRecordVoice: "Re-record", addEvent: "Add Event", logs: "Logs", toggleLogs: "Logs", addQuestion: "Add Question", editQuestion: "Edit", deleteQuestion: "Delete", confirmDelete: "Please type the chat name to confirm deletion:", enterChatName: "Enter Chat Name", tutorial: "Tutorial", next: "Next", selectChat: "Select Chat", typeMessage: "Type a message", loginPrompt: "Please log in or sign up to continue.", signupSuccess: "Signup successful! Please verify your email.", loginSuccess: "Login successful!", logoutSuccess: "Logout successful!", eventAdded: "Event added successfully!", eventCancelled: "Event addition cancelled.", errorOccurred: "An error occurred. Please try again.", upcomingEvents: "Upcoming Events (Next 15 Days)", noUpcomingEvents: "No upcoming events.", manageQuestions: "Manage Questions", questionType: "Question Type:", toggle: "Toggle", slider: "Slider", questionLabel: "Question Label:", sliderMin: "Slider Minimum Value:", sliderMax: "Slider Maximum Value:", hasComment: "Requires Comment?", promote: "Promote", demote: "Demote" },
      fr: { appTitle: "Caty Health Tracker", realTimeRadar: "Radar de santé en temps réel", dailyHealthChecklist: "Checklist santé quotidienne", healthMetrics: "Métriques de santé au fil du temps", summaryRadar: "Radar de synthèse au fil du temps", save: "Enregistrer", send: "Envoyer", recordVoice: "Démarrer l'enregistrement", stopVoice: "Arrêter", sendVoice: "Publier", reRecordVoice: "Re-enregistrer", addEvent: "Ajouter un événement", logs: "Journaux", toggleLogs: "Journaux", addQuestion: "Ajouter une question", editQuestion: "Modifier", deleteQuestion: "Supprimer", confirmDelete: "Veuillez taper le nom du chat pour confirmer la suppression :", enterChatName: "Entrez le nom du chat", tutorial: "Tutoriel", next: "Suivant", selectChat: "Sélectionner un chat", typeMessage: "Tapez un message", loginPrompt: "Veuillez vous connecter ou vous inscrire pour continuer.", signupSuccess: "Inscription réussie ! Veuillez vérifier votre email.", loginSuccess: "Connexion réussie !", logoutSuccess: "Déconnexion réussie !", eventAdded: "Événement ajouté avec succès !", eventCancelled: "Ajout d'événement annulé.", errorOccurred: "Une erreur s'est produite. Veuillez réessayer.", upcomingEvents: "Événements à venir (15 prochains jours)", noUpcomingEvents: "Aucun événement à venir.", manageQuestions: "Gérer les Questions", questionType: "Type de question :", toggle: "Toggle", slider: "Slider", questionLabel: "Libellé de la question :", sliderMin: "Valeur minimale du slider :", sliderMax: "Valeur maximale du slider :", hasComment: "Requiert un commentaire ?", promote: "Promouvoir", demote: "Rétrograder" }
    };
    let currentLanguage = localStorage.getItem('selectedLanguage') || 'en';
    let firebaseConfigStored = null;
    const catsData = [];
    let currentChatIndex = 0;
    let realtimeRadar, timeSeriesChart, summaryRadarChart;
    let mediaRecorder = null;
    let isRecording = false;
    let recordedVoice = null;
    let audioChunks = [];
    let tutorialStep = 0;
    const tutorialSteps = {
      en: [
        { title: "Welcome", text: "Welcome to Caty Health Tracker! Follow the steps to get started." },
        { title: "Create a Chat", text: "Click on 'Create Chat' to add a new chat." },
        { title: "Fill the Checklist", text: "Fill out the daily checklist to monitor your cat's health." },
        { title: "Real-Time Radar", text: "The radar updates in real-time based on your responses." },
        { title: "Health Metrics", text: "View health metrics over time in the charts." },
        { title: "Export to Excel", text: "Export the chat data to Excel for easy sharing and analysis." },
        { title: "Share Chat", text: "Share your chat with others using a secure code." },
        { title: "Manage Questions", text: "Edit the list of questions specific to this chat." }
      ],
      fr: [
        { title: "Bienvenue", text: "Bienvenue dans Caty Health Tracker! Suivez les étapes pour commencer." },
        { title: "Créer un Chat", text: "Cliquez sur 'Créer un chat' pour ajouter un nouveau chat." },
        { title: "Remplir la Checklist", text: "Remplissez la checklist quotidienne pour surveiller la santé de votre chat." },
        { title: "Radar en Temps Réel", text: "Le radar se met à jour en temps réel en fonction de vos réponses." },
        { title: "Métriques de Santé", text: "Consultez les métriques de santé au fil du temps dans les graphiques." },
        { title: "Exporter vers Excel", text: "Exportez les données du chat vers Excel pour un partage et une analyse faciles." },
        { title: "Partager le Chat", text: "Partagez votre chat avec d'autres utilisateurs via un code sécurisé." },
        { title: "Gérer les Questions", text: "Modifiez la liste des questions spécifiques à ce chat." }
      ]
    };
    const offlineQueue = [];
    function logMessage(type, message) {
      const logContainer = document.getElementById("logs");
      if (!logContainer) return;
      const logEntry = document.createElement("div");
      logEntry.classList.add("log-entry", type);
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
      console[type === 'error' ? 'error' : type === 'warning' ? 'warn' : 'log'](`Log (${type}): ${message}`);
    }
    function changeLanguage(lang) {
      currentLanguage = lang;
      localStorage.setItem('selectedLanguage', lang);
      document.querySelectorAll('[data-key]').forEach(element => {
        const key = element.getAttribute('data-key');
        if (languages[lang][key]) {
          if (element.tagName.toLowerCase() === 'input' || element.tagName.toLowerCase() === 'textarea') {
            element.placeholder = languages[lang][key];
          } else {
            element.textContent = languages[lang][key];
          }
        }
      });
      updateModalTranslations();
      if (document.getElementById("manageQuestionsModal").style.display === "flex") {
        renderQuestionsList();
      }
    }
    function getTranslation(key) {
      return languages[currentLanguage][key] || key;
    }
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = "none";
      if (modalId === 'deleteChatModal') {
        const input = document.getElementById("confirmChatName");
        const errorMsg = document.getElementById("deleteError");
        input.classList.remove("error");
        errorMsg.style.display = "none";
        input.value = "";
      }
    }
    function submitLanguage() {
      const lang = document.getElementById("initialLanguageSelector").value;
      if (!lang) {
        logMessage("warning", "No language selected.");
        return;
      }
      changeLanguage(lang);
      closeModal('languageModal');
      document.getElementById("firebaseConfigModal").style.display = "flex";
    }
    function submitFirebaseConfig() {
      const apiKey = document.getElementById("apiKey").value.trim();
      const authDomain = document.getElementById("authDomain").value.trim();
      const databaseURL = document.getElementById("databaseURL").value.trim();
      const projectId = document.getElementById("projectId").value.trim();
      const storageBucket = document.getElementById("storageBucket").value.trim();
      const messagingSenderId = document.getElementById("messagingSenderId").value.trim();
      const appId = document.getElementById("appId").value.trim();
      if (!apiKey || !authDomain || !databaseURL || !projectId || !storageBucket || !messagingSenderId || !appId) {
        logMessage("warning", "Incomplete Firebase configuration.");
        alert(getTranslation('errorOccurred'));
        return;
      }
      const config = { apiKey, authDomain, databaseURL, projectId, storageBucket, messagingSenderId, appId };
      initializeFirebaseWithConfig(config);
    }
    function initializeFirebaseWithConfig(config) {
      try {
        if (firebase.apps.length) {
          firebase.app().delete().then(() => {
            firebase.initializeApp(config);
            firebaseConfigStored = config;
            localStorage.setItem("firebaseConfig", JSON.stringify(config));
            logMessage("info", "Firebase configuration initialized.");
            closeModal("firebaseConfigModal");
            document.getElementById("authModal").style.display = "flex";
          }).catch(err => {
            logMessage("error", `Error resetting Firebase: ${err}`);
            alert(getTranslation('errorOccurred'));
          });
        } else {
          firebase.initializeApp(config);
          firebaseConfigStored = config;
          localStorage.setItem("firebaseConfig", JSON.stringify(config));
          logMessage("info", "Firebase configuration initialized.");
          closeModal("firebaseConfigModal");
          document.getElementById("authModal").style.display = "flex";
        }
      } catch (error) {
        logMessage("error", `Error initializing Firebase: ${error}`);
        alert(getTranslation('errorOccurred'));
      }
    }
    function initializeFirebase() {
      const config = JSON.parse(localStorage.getItem("firebaseConfig"));
      if (config) {
        firebaseConfigStored = config;
        try {
          if (!firebase.apps.length) {
            firebase.initializeApp(config);
            logMessage("info", "Firebase initialized successfully.");
          } else {
            logMessage("info", "Firebase was already initialized.");
          }
          firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
            firebase.auth().onAuthStateChanged((user) => {
              if (user) {
                document.getElementById("logoutBtn").style.display = "inline-block";
                document.getElementById("app").style.display = "flex";
                document.getElementById("authModal").style.display = "none";
                logMessage("info", `User "${user.email}" authenticated.`);
                loadUserChats();
                checkShareURL(user);
              } else {
                document.getElementById("logoutBtn").style.display = "none";
                document.getElementById("app").style.display = "none";
                document.getElementById("authModal").style.display = "flex";
                logMessage("info", "No user authenticated.");
                catsData.length = 0;
                renderChatSelector();
                clearSections();
              }
            });
          });
        } catch (error) {
          logMessage("error", `Error initializing Firebase: ${error}`);
          alert(getTranslation('errorOccurred'));
          document.getElementById("firebaseConfigModal").style.display = "flex";
        }
      } else {
        document.getElementById("languageModal").style.display = "flex";
        logMessage("warning", "Firebase configuration not found. Prompting to configure.");
      }
    }
    function loadUserChats() {
      const user = firebase.auth().currentUser;
      if (!user) return;
      const userId = user.uid;
      const dbRef = firebase.database().ref(`/users/${userId}/chats`);
      dbRef.on('value', snapshot => {
        const data = snapshot.val();
        catsData.length = 0;
        if (data) {
          Object.values(data).forEach(chat => {
            if (!chat.calendar) chat.calendar = [];
            catsData.push(chat);
          });
        }
        renderChatSelector();
        updateDeleteChatButton();
        logMessage("info", "Data synchronized from Firebase for the user.");
      }, (error) => {
        logMessage("error", `Firebase Realtime Database error: ${error}`);
      });
    }
    function renderChatSelector() {
      const selector = document.getElementById("chatSelector");
      selector.innerHTML = `<option value="" disabled selected>${getTranslation('selectChat')}</option>` + 
        catsData.map((chat, i) => `<option value="${i}">${chat.name}</option>`).join("");
      if (catsData.length > 0) {
        selector.value = currentChatIndex;
        selectChat();
      }
    }
    function selectChat() {
      const selector = document.getElementById("chatSelector");
      currentChatIndex = parseInt(selector.value, 10);
      if (isNaN(currentChatIndex) || currentChatIndex < 0 || currentChatIndex >= catsData.length) {
        logMessage("warning", "Invalid chat index.");
        return;
      }
      const isConnected = catsData[currentChatIndex].code !== undefined;
      ["chartsSection", "timeSeriesSection", "summaryChartSection", "quizSection", "chatSection", "calendarSection"].forEach(id => {
        document.getElementById(id).style.display = isConnected ? "block" : "none";
      });
      if (isConnected) {
        renderQuiz();
        renderRealtimeRadar();
        renderTimeSeriesChart();
        renderSummaryRadarChart();
        renderChat();
        renderCalendar();
        renderUpcomingEvents();
        document.getElementById("manageQuestions").style.display = "inline-block";
      } else {
        clearSections();
        document.getElementById("manageQuestions").style.display = "none";
      }
      updateDeleteChatButton();
      logMessage("info", `Switched to chat "${catsData[currentChatIndex].name}".`);
    }
    function updateDeleteChatButton() {
      const deleteBtn = document.getElementById("deleteChatBtn");
      deleteBtn.style.display = catsData.length > 0 ? "inline-block" : "none";
    }
    function clearSections() {
      [realtimeRadar, timeSeriesChart, summaryRadarChart].forEach(chart => { if (chart) chart.destroy(); });
      document.getElementById("quizForm").innerHTML = "";
      document.getElementById("messages").innerHTML = "";
      document.getElementById("calendar").innerHTML = "";
      document.getElementById("upcomingEventsList").innerHTML = "";
    }
    const forms = {
      default: [
        { label: "Has the cat eaten today?", type: "toggle" },
        { label: "Number of meals today (0-10)", type: "slider", min: 0, max: 10 },
        { label: "Has the cat drunk water today?", type: "toggle" },
        { label: "Has Palladia medication been administered?", type: "toggle" },
        { label: "Has cortisone medication been administered?", type: "toggle" },
        { label: "Has the cat vomited recently?", type: "toggle" },
        { label: "Have you noticed a significant decrease in appetite?", type: "toggle" },
        { label: "Have you seen urine in the litter box?", type: "toggle" },
        { label: "Has the cat defecated today?", type: "toggle" },
        { label: "Consistency of stool (1 = liquid, 10 = very hard)", type: "slider", min: 1, max: 10 },
        { label: "Does the cat seem active as usual?", type: "toggle" },
        { label: "Is the cat meowing more than usual?", type: "toggle" },
        { label: "Have you noticed any physical anomalies (weight loss, swelling)?", type: "toggle" },
        { label: "Does the cat seem to be in pain?", type: "toggle" },
        { label: "General activity level (1 = lethargic, 10 = very active)", type: "slider", min: 1, max: 10 },
        { label: "Does the cat seem to be drinking more than usual?", type: "toggle" },
        { label: "Is the cat breathing normally?", type: "toggle" },
        { label: "Is the cat scratching excessively?", type: "toggle" },
        { label: "Is the cat showing signs of aggression?", type: "toggle" },
        { label: "Is the cat urinating normally?", type: "toggle" },
        { label: "Is the cat showing signs of jaundice?", type: "toggle" }
      ]
    };
    function renderQuiz() {
      if (!catsData.length) return;
      const quizContainer = document.getElementById("quizForm");
      const form = catsData[currentChatIndex].form || forms["default"];
      const lastEntry = catsData[currentChatIndex].history && catsData[currentChatIndex].history.length > 0 ? catsData[currentChatIndex].history[catsData[currentChatIndex].history.length - 1].answers : [];
      quizContainer.innerHTML = form.map((q, i) => {
        if (q.type === "toggle") {
          let checked = false;
          let comment = "";
          if (lastEntry[i]) {
            checked = typeof lastEntry[i] === "object" ? lastEntry[i].value === 10 : lastEntry[i] === 10;
            comment = typeof lastEntry[i] === "object" ? lastEntry[i].comment : "";
          }
          return `
            <div class="question-container">
              <label class="switch">
                <input type="checkbox" data-index="${i}" onchange="toggleAnswer(${i}, this.checked)" ${checked ? "checked" : ""}>
                <span class="slider-switch"></span>
              </label>
              <label>${q.label}</label>
              ${q.hasComment ? `<textarea id="comment${i}" placeholder="${getTranslation('typeMessage')}" style="display:${checked ? "block" : "none"};">${comment}</textarea>` : ''}
            </div>
          `;
        } else if (q.type === "slider") {
          let value = Math.floor((q.min + q.max) / 2);
          if (lastEntry[i] !== undefined) { value = lastEntry[i]; }
          let valueClass = "good";
          const mid = (q.min + q.max) / 2;
          if (value <= mid) { valueClass = "good"; }
          else if (value > mid && value < q.max) { valueClass = "warning"; }
          else { valueClass = "bad"; }
          return `
            <div class="slider-container">
              <label for="slider${i}">${q.label}</label>
              <div class="slider-input">
                <input type="range" id="slider${i}" min="${q.min}" max="${q.max}" value="${value}" oninput="updateSliderValue(${i}, this.value)">
                <span class="slider-value ${valueClass}" id="sliderValue${i}">${value}</span>
              </div>
            </div>
          `;
        }
        return "";
      }).join('');
    }
    function toggleAnswer(index, isChecked) {
      const form = catsData[currentChatIndex].form || forms["default"];
      const question = form[index];
      if (question.hasComment) {
        const commentField = document.getElementById(`comment${index}`);
        commentField.style.display = isChecked ? "block" : "none";
        if (!isChecked) { commentField.value = ""; }
      }
      renderRealtimeRadar();
      renderSummaryRadarChart();
    }
    function updateSliderValue(index, value) {
      const valueSpan = document.getElementById(`sliderValue${index}`);
      valueSpan.textContent = value;
      const form = catsData[currentChatIndex].form || forms["default"];
      const q = form[index];
      const min = parseInt(q.min, 10);
      const max = parseInt(q.max, 10);
      const mid = (min + max) / 2;
      if (value <= mid) { valueSpan.classList.add("good"); valueSpan.classList.remove("warning", "bad"); }
      else if (value > mid && value < max) { valueSpan.classList.add("warning"); valueSpan.classList.remove("good", "bad"); }
      else { valueSpan.classList.add("bad"); valueSpan.classList.remove("good", "warning"); }
      renderRealtimeRadar();
      renderSummaryRadarChart();
    }
    function currentAnswers() {
      if (!catsData.length) return [];
      const form = catsData[currentChatIndex].form || forms["default"];
      const answers = form.map((q, i) => {
        if (q.type === "toggle") {
          const toggle = document.querySelector(`input[data-index="${i}"]`);
          if (q.hasComment) {
            const comment = document.getElementById(`comment${i}`).value.trim();
            return toggle ? { value: toggle.checked ? 10 : 0, comment: toggle.checked ? comment : "" } : { value: 0, comment: "" };
          }
          return toggle ? (toggle.checked ? 10 : 0) : 0;
        } else if (q.type === "slider") {
          const slider = document.getElementById(`slider${i}`);
          return slider ? parseInt(slider.value, 10) : 0;
        }
        return 0;
      });
      return answers;
    }
    function saveAnswers() {
      if (!catsData.length) { logMessage("warning", "No chat available to save answers."); return; }
      const answers = currentAnswers();
      const timestamp = Date.now();
      const historyEntry = { timestamp, answers };
      if (!catsData[currentChatIndex].history) { catsData[currentChatIndex].history = []; }
      catsData[currentChatIndex].history.push(historyEntry);
      saveChatToDatabase(catsData[currentChatIndex]);
      renderTimeSeriesChart();
      renderRealtimeRadar();
      renderSummaryRadarChart();
      logMessage("info", "Answers saved successfully.");
    }
    function saveChatToDatabase(chat) {
      const user = firebase.auth().currentUser;
      if (!user) return Promise.reject("No authenticated user.");
      const userId = user.uid;
      const dbRef = firebase.database().ref(`/users/${userId}/chats/${chat.code}`);
      return dbRef.set(chat).then(() => logMessage("info", "Chat data saved to database."));
    }
    function renderRealtimeRadar() {
      if (!catsData.length) return;
      const answers = currentAnswers();
      const data = answers.map(a => (typeof a === "object" ? a.value : a));
      const labels = catsData[currentChatIndex].form.map(q => q.label);
      if (realtimeRadar) { realtimeRadar.destroy(); }
      const ctx = document.getElementById("realtimeRadar").getContext("2d");
      realtimeRadar = new Chart(ctx, {
        type: "radar",
        data: { labels, datasets: [{ label: "Current Health", data, backgroundColor: "rgba(255, 99, 132, 0.2)", borderColor: "rgba(255, 99, 132, 1)", borderWidth: 1 }] },
        options: { responsive: true, scales: { r: { beginAtZero: true, max: 10 } } }
      });
    }
    function renderTimeSeriesChart() {
      if (!catsData.length || !catsData[currentChatIndex].history) return;
      const history = catsData[currentChatIndex].history;
      const labels = history.map(entry => new Date(entry.timestamp).toLocaleString());
      const form = catsData[currentChatIndex].form || forms["default"];
      const datasets = form.map((q, i) => ({
        label: q.label,
        data: history.map(entry => entry.answers[i] || 0),
        fill: false,
        borderColor: `hsl(${(i * 50) % 360}, 70%, 50%)`,
        tension: 0.1
      }));
      if (timeSeriesChart) { timeSeriesChart.destroy(); }
      const ctx = document.getElementById("timeSeriesChart").getContext("2d");
      timeSeriesChart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: { responsive: true, scales: { y: { beginAtZero: true, max: 10 } } }
      });
    }
    function renderSummaryRadarChart() {
      if (!catsData.length || !catsData[currentChatIndex].history) return;
      const history = catsData[currentChatIndex].history;
      const labels = catsData[currentChatIndex].form.map(q => q.label);
      const data = labels.map((_, i) => history.map(entry => entry.answers[i] || 0).reduce((sum, value) => sum + value, 0) / history.length);
      if (summaryRadarChart) { summaryRadarChart.destroy(); }
      const ctx = document.getElementById("summaryRadarChart").getContext("2d");
      summaryRadarChart = new Chart(ctx, {
        type: "radar",
        data: { labels, datasets: [{ label: "Summary", data, backgroundColor: "rgba(54, 162, 235, 0.2)", borderColor: "rgba(54, 162, 235, 1)", borderWidth: 1 }] },
        options: { responsive: true, scales: { r: { beginAtZero: true, max: 10 } } }
      });
    }
    function createChat() {
      const name = prompt("Enter Chat Name:");
      if (!name) { logMessage("warning", "No name entered for new chat."); return; }
      const code = generateSecureCode();
      const user = firebase.auth().currentUser;
      if (!user) { logMessage("warning", "User attempted to create chat without authentication."); return; }
      const newChat = { name: name.trim(), code, history: [], form: JSON.parse(JSON.stringify(forms["default"])), members: { [user.uid]: { email: user.email, role: "admin" } }, calendar: [] };
      catsData.push(newChat);
      saveChatToDatabase(newChat).then(() => {
        renderChatSelector();
        selectChat();
        updateDeleteChatButton();
        logMessage("info", `New chat "${name}" created successfully.`);
      });
    }
    function generateSecureCode() {
      return Math.random().toString(36).substring(2, 15).toUpperCase() + Math.random().toString(36).substring(2, 15).toUpperCase();
    }
    function shareChat() {
      if (!catsData.length) { logMessage("warning", "No chat available to share."); return; }
      const currentChat = catsData[currentChatIndex];
      const shareCode = currentChat.code;
      const shareURL = `${window.location.origin}${window.location.pathname}?share=${shareCode}`;
      navigator.clipboard.writeText(shareURL).then(() => {
        logMessage("info", `Chat "${currentChat.name}" shared via URL.`);
        alert("Chat share URL copied to clipboard!");
      }).catch(err => {
        logMessage("error", `Failed to copy share URL: ${err}`);
        alert("Failed to copy share URL.");
      });
    }
    function deleteChat() {
      if (!catsData.length) return;
      const currentChat = catsData[currentChatIndex];
      const user = firebase.auth().currentUser;
      if (!user || !currentChat.members[user.uid] || currentChat.members[user.uid].role !== "admin") return;
      document.getElementById("deleteChatModal").style.display = "flex";
    }
    function confirmDeleteChat() {
      const currentChat = catsData[currentChatIndex];
      const confirmation = document.getElementById("confirmChatName").value.trim();
      const inputField = document.getElementById("confirmChatName");
      const errorMsg = document.getElementById("deleteError");
      if (confirmation === currentChat.name) {
        const user = firebase.auth().currentUser;
        if (!user) return;
        firebase.database().ref(`/users/${user.uid}/chats/${currentChat.code}`).remove().then(() => {
          logMessage("info", `Chat "${currentChat.name}" deleted successfully.`);
          catsData.splice(currentChatIndex, 1);
          renderChatSelector();
          clearSections();
          closeModal("deleteChatModal");
          updateDeleteChatButton();
        }).catch(err => { logMessage("error", `Error deleting chat "${currentChat.name}": ${err}`); });
      } else {
        logMessage("warning", "Chat name confirmation failed.");
        inputField.classList.add("error");
        errorMsg.style.display = "block";
      }
    }
    function showAddEventModal() {
      document.getElementById("addEventModal").style.display = "flex";
      document.getElementById("eventTitle").value = "";
      document.getElementById("eventDateTime").value = "";
      document.getElementById("eventDescription").value = "";
      if (window.selectedDate) {
        const selectedDate = window.selectedDate;
        const formattedDate = selectedDate.toISOString().slice(0,16);
        document.getElementById("eventDateTime").value = formattedDate;
      }
    }
    function addEvent() {
      const title = document.getElementById("eventTitle").value.trim();
      const dateTime = document.getElementById("eventDateTime").value;
      const description = document.getElementById("eventDescription").value.trim();
      if (!title || !dateTime) { logMessage("warning", "No event title or date/time entered."); alert(getTranslation('errorOccurred')); return; }
      const eventDate = new Date(dateTime);
      if (isNaN(eventDate.getTime())) { logMessage("warning", "Invalid date/time entered."); alert(getTranslation('errorOccurred')); return; }
      const id = 'event-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      const event = { id, title, description, date: eventDate.toISOString() };
      catsData[currentChatIndex].calendar.push(event);
      saveChatToDatabase(catsData[currentChatIndex]).then(() => {
        renderCalendar();
        closeModal("addEventModal");
        logMessage("info", `Event "${title}" added to calendar.`);
        alert(getTranslation('eventAdded'));
      }).catch(err => { logMessage("error", `Failed to add event: ${err}`); alert(getTranslation('errorOccurred')); });
    }
    function renderCalendar() {
      if (!catsData.length) return;
      const calendarContainer = document.getElementById("calendar");
      calendarContainer.innerHTML = '';
      const calendar = catsData[currentChatIndex].calendar || [];
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = document.createElement("div");
        dayDiv.classList.add("calendar-day");
        const date = new Date(year, month, day);
        dayDiv.textContent = day;
        const dayEvents = calendar.filter(event => {
          const eventDate = new Date(event.date);
          return eventDate.getDate() === day && eventDate.getMonth() === month && eventDate.getFullYear() === year;
        });
        if (dayEvents.length > 0) {
          dayDiv.classList.add("has-event");
          const tooltip = document.createElement("div");
          tooltip.classList.add("tooltip");
          tooltip.innerHTML = `<strong>Events:</strong><br>${dayEvents.map(event => `
            <div class="tooltip-event" data-event-id="${event.id}">
              <em>${event.title}</em>: ${event.description}
              <div class="event-actions">
                <button class="edit-event-btn">Edit</button>
                <button class="delete-event-btn">Delete</button>
              </div>
            </div>
          `).join('<br>')}`;
          dayDiv.appendChild(tooltip);
        }
        dayDiv.onclick = () => {
          window.selectedDate = date;
          showAddEventModal();
        };
        calendarContainer.appendChild(dayDiv);
      }
      logMessage("info", "Calendar rendered.");
    }
    function renderUpcomingEvents() {
      if (!catsData.length) return;
      const upcomingList = document.getElementById("upcomingEventsList");
      upcomingList.innerHTML = '';
      const calendar = catsData[currentChatIndex].calendar || [];
      const now = new Date();
      const futureDate = new Date();
      futureDate.setDate(now.getDate() + 15);
      const upcomingEvents = calendar.filter(event => {
        const eventDate = new Date(event.date);
        return eventDate >= now && eventDate <= futureDate;
      }).sort((a, b) => new Date(a.date) - new Date(b.date));
      if (upcomingEvents.length === 0) {
        upcomingList.innerHTML = `<li>${getTranslation('noUpcomingEvents')}</li>`;
        return;
      }
      upcomingEvents.forEach(event => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${event.title}</strong><br>${event.description}<br><em>${new Date(event.date).toLocaleString()}</em>`;
        upcomingList.appendChild(li);
      });
    }
    function toggleLogs() {
      const logs = document.getElementById("logsContainer");
      logs.style.display = (logs.style.display === "none" || logs.style.display === "") ? "flex" : "none";
    }
    function authenticate() {
      const authTitle = document.getElementById("authTitle").innerText;
      const email = document.getElementById("authEmail").value.trim();
      const password = document.getElementById("authPassword").value;
      if (!email || !password) { logMessage("warning", "Authentication fields left empty."); alert(getTranslation('errorOccurred')); return; }
      if (authTitle === getTranslation('login')) {
        firebase.auth().signInWithEmailAndPassword(email, password).then((userCredential) => {
          if (!userCredential.user.emailVerified) { logMessage("warning", "User attempted to login without verifying email."); alert("Please verify your email before logging in."); firebase.auth().signOut(); return; }
          logMessage("info", `User "${userCredential.user.email}" logged in.`);
          alert(getTranslation('loginSuccess'));
          closeModal("authModal");
        }).catch((error) => { logMessage("error", `Login error: ${error.message}`); alert(`Error: ${error.message}`); });
      } else {
        if (password.length < 8 || !/[A-Z]/.test(password) || !/[a-z]/.test(password) || !/\d/.test(password) || !/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
          alert("Password must be at least 8 characters long and include uppercase, lowercase, number, and special character.");
          logMessage("warning", "User entered weak password during signup.");
          return;
        }
        firebase.auth().createUserWithEmailAndPassword(email, password).then((userCredential) => {
          userCredential.user.sendEmailVerification();
          logMessage("info", `User "${userCredential.user.email}" signed up.`);
          alert(getTranslation('signupSuccess'));
          closeModal("authModal");
        }).catch((error) => { logMessage("error", `Signup error: ${error.message}`); alert(`Error: ${error.message}`); });
      }
    }
    function toggleAuthMode() {
      const authTitle = document.getElementById("authTitle").innerText;
      const signupText = getTranslation('signup');
      const loginText = getTranslation('login');
      if (authTitle === loginText) {
        document.getElementById("authTitle").innerText = signupText;
        document.querySelector("button[onclick='authenticate()']").innerText = signupText;
        document.querySelector("button[onclick='toggleAuthMode()']").innerText = loginText;
      } else {
        document.getElementById("authTitle").innerText = loginText;
        document.querySelector("button[onclick='authenticate()']").innerText = loginText;
        document.querySelector("button[onclick='toggleAuthMode()']").innerText = signupText;
      }
    }
    function logout() {
      firebase.auth().signOut().then(() => { logMessage("info", "User logged out."); alert(getTranslation('logoutSuccess')); }).catch((error) => { logMessage("error", `Logout error: ${error.message}`); alert(`Error: ${error.message}`); });
    }
    function renderChat() {
      if (!catsData.length) return;
      const messagesContainer = document.getElementById("messages");
      messagesContainer.innerHTML = "";
      const user = firebase.auth().currentUser;
      if (!user) return;
      const chatCode = catsData[currentChatIndex].code;
      const chatRef = firebase.database().ref(`/chats/${chatCode}/messages`);
      chatRef.on('child_added', snapshot => {
        const msg = snapshot.val();
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message");
        if (msg.user === user.email) messageDiv.classList.add("user");
        const avatarDiv = document.createElement("div");
        avatarDiv.classList.add("avatar");
        messageDiv.appendChild(avatarDiv);
        const textDiv = document.createElement("div");
        textDiv.classList.add("text");
        if (msg.type === "text") { textDiv.textContent = msg.content; }
        else if (msg.type === "voice") { const audio = document.createElement("audio"); audio.src = msg.content; audio.controls = true; textDiv.appendChild(audio); }
        messageDiv.appendChild(textDiv);
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });
      renderChatMembers();
    }
    function renderChatMembers() {
      const user = firebase.auth().currentUser;
      if (!user) return;
      const chatCode = catsData[currentChatIndex].code;
      const members = catsData[currentChatIndex].members;
      const usersList = document.getElementById("usersList");
      usersList.innerHTML = '';
      for (const uid in members) {
        const member = members[uid];
        const li = document.createElement("li");
        li.innerHTML = `${member.email} - ${member.role === "admin" ? "Admin" : "User"}`;
        if (member.role !== "admin") {
          const promoteBtn = document.createElement("button");
          promoteBtn.textContent = getTranslation('promote');
          promoteBtn.onclick = () => promoteUser(uid);
          li.appendChild(promoteBtn);
        } else {
          if (uid !== user.uid) {
            const demoteBtn = document.createElement("button");
            demoteBtn.textContent = getTranslation('demote');
            demoteBtn.onclick = () => demoteUser(uid);
            li.appendChild(demoteBtn);
          }
        }
        usersList.appendChild(li);
      }
    }
    function addQuestion() {
      const user = firebase.auth().currentUser;
      if (!user) { logMessage("warning", "User attempted to add a question without authentication."); alert(getTranslation('loginPrompt')); return; }
      const isAdmin = catsData[currentChatIndex].members[user.uid].role === "admin";
      if (!isAdmin) { logMessage("warning", "User attempted to add a question without admin permissions."); return; }
      const questionLabel = prompt(getTranslation('questionLabel'));
      if (!questionLabel) { logMessage("warning", "No question label entered."); return; }
      const questionType = prompt(`${getTranslation('questionType')} (${getTranslation('toggle')}/${getTranslation('slider')}):`);
      if (!['toggle', 'slider'].includes(questionType)) { logMessage("warning", "Invalid question type entered."); alert("Invalid question type. Please enter 'toggle' or 'slider'."); return; }
      let min = null, max = null;
      if (questionType === 'slider') {
        min = parseInt(prompt(getTranslation('sliderMin')), 10);
        max = parseInt(prompt(getTranslation('sliderMax')), 10);
        if (isNaN(min) || isNaN(max) || min >= max) { logMessage("warning", "Invalid slider min/max values entered."); alert("Invalid slider min/max values."); return; }
      }
      const hasComment = confirm(getTranslation('hasComment'));
      const newQuestion = { label: questionLabel, type: questionType };
      if (questionType === 'slider') { newQuestion.min = min; newQuestion.max = max; }
      if (hasComment) { newQuestion.hasComment = true; }
      catsData[currentChatIndex].form.push(newQuestion);
      saveChatToDatabase(catsData[currentChatIndex]).then(() => {
        renderQuiz();
        renderRealtimeRadar();
        renderTimeSeriesChart();
        renderSummaryRadarChart();
        renderQuestionsList();
        logMessage("info", `Question added: "${questionLabel}".`);
        alert("Question added successfully!");
      }).catch(err => { logMessage("error", `Failed to add question: ${err}`); alert("Failed to add question."); });
    }
    function renderQuestionsList() {
      const questionsList = document.getElementById("questionsList");
      questionsList.innerHTML = '';
      const form = catsData[currentChatIndex].form || forms["default"];
      form.forEach((q, index) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <span>${q.label} (${q.type})${q.type === 'slider' ? ` [${q.min} - ${q.max}]` : ''}${q.hasComment ? ' 🔍' : ''}</span>
          <div class="question-actions">
            <button onclick="editQuestion(${index})">${getTranslation('editQuestion')}</button>
            <button onclick="deleteQuestion(${index})">${getTranslation('deleteQuestion')}</button>
          </div>
        `;
        questionsList.appendChild(li);
      });
    }
    function editQuestion(index) {
      const user = firebase.auth().currentUser;
      if (!user) { logMessage("warning", "User attempted to edit a question without authentication."); alert(getTranslation('loginPrompt')); return; }
      const isAdmin = catsData[currentChatIndex].members[user.uid].role === "admin";
      if (!isAdmin) { logMessage("warning", "User attempted to edit a question without admin permissions."); return; }
      const form = catsData[currentChatIndex].form || forms["default"];
      const question = form[index];
      const newLabel = prompt(getTranslation('questionLabel'), question.label);
      if (!newLabel) { logMessage("warning", "No question label entered during edit."); return; }
      const newType = prompt(`${getTranslation('questionType')} (${getTranslation('toggle')}/${getTranslation('slider')}):`, question.type);
      if (!['toggle', 'slider'].includes(newType)) { logMessage("warning", "Invalid question type entered during edit."); alert("Invalid question type. Please enter 'toggle' or 'slider'."); return; }
      let min = null, max = null;
      if (newType === 'slider') {
        min = parseInt(prompt(getTranslation('sliderMin'), question.min), 10);
        max = parseInt(prompt(getTranslation('sliderMax'), question.max), 10);
        if (isNaN(min) || isNaN(max) || min >= max) { logMessage("warning", "Invalid slider min/max values entered during edit."); alert("Invalid slider min/max values."); return; }
      }
      const hasComment = confirm(getTranslation('hasComment'));
      const updatedQuestion = { label: newLabel, type: newType };
      if (newType === 'slider') { updatedQuestion.min = min; updatedQuestion.max = max; }
      if (hasComment) { updatedQuestion.hasComment = true; }
      catsData[currentChatIndex].form[index] = updatedQuestion;
      saveChatToDatabase(catsData[currentChatIndex]).then(() => {
        renderQuiz();
        renderRealtimeRadar();
        renderTimeSeriesChart();
        renderSummaryRadarChart();
        renderQuestionsList();
        logMessage("info", `Question edited: "${newLabel}".`);
        alert("Question edited successfully!");
      }).catch(err => { logMessage("error", `Failed to edit question: ${err}`); alert("Failed to edit question."); });
    }
    function deleteQuestion(index) {
      const user = firebase.auth().currentUser;
      if (!user) { logMessage("warning", "User attempted to delete a question without authentication."); alert(getTranslation('loginPrompt')); return; }
      const isAdmin = catsData[currentChatIndex].members[user.uid].role === "admin";
      if (!isAdmin) { logMessage("warning", "User attempted to delete a question without admin permissions."); return; }
      if (confirm("Are you sure you want to delete this question?")) {
        const form = catsData[currentChatIndex].form || forms["default"];
        const removedQuestion = form.splice(index, 1)[0];
        saveChatToDatabase(catsData[currentChatIndex]).then(() => {
          renderQuiz();
          renderRealtimeRadar();
          renderTimeSeriesChart();
          renderSummaryRadarChart();
          renderQuestionsList();
          logMessage("info", `Question deleted: "${removedQuestion.label}".`);
          alert("Question deleted successfully!");
        }).catch(err => { logMessage("error", `Failed to delete question: ${err}`); alert("Failed to delete question."); });
      }
    }
    function sendMessage() {
      if (!catsData.length) return;
      const messageInput = document.getElementById("messageInput");
      const message = messageInput.value.trim();
      if (!message) return;
      const user = firebase.auth().currentUser;
      if (!user) { logMessage("warning", "User attempted to send message without authentication."); alert(getTranslation('loginPrompt')); return; }
      const chatCode = catsData[currentChatIndex].code;
      const chatRef = firebase.database().ref(`/chats/${chatCode}/messages`).push();
      chatRef.set({ user: user.email, type: "text", content: message, timestamp: Date.now() });
      messageInput.value = "";
    }
    function toggleRecording() {
      const recordButton = document.getElementById("recordButton");
      const stopRecordButton = document.getElementById("stopRecordButton");
      if (!isRecording) {
        if (!navigator.mediaDevices) { logMessage("error", "Media devices not supported."); return; }
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.start();
          isRecording = true;
          recordButton.style.display = "none";
          stopRecordButton.style.display = "inline-block";
          mediaRecorder.ondataavailable = e => { audioChunks.push(e.data); };
          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
            const reader = new FileReader();
            reader.onloadend = () => { recordedVoice = reader.result; document.getElementById("sendVoiceButton").style.display = "inline-block"; document.getElementById("reRecordButton").style.display = "inline-block"; logMessage("info", "Recording stopped and ready to send."); };
            reader.readAsDataURL(audioBlob);
            audioChunks = [];
            isRecording = false;
            recordButton.style.display = "inline-block";
            stopRecordButton.style.display = "none";
          };
          logMessage("info", "Recording started.");
        }).catch(err => { logMessage("error", `Microphone access denied: ${err}`); alert("Microphone access denied."); });
      }
    }
    function stopRecording() {
      if (mediaRecorder && isRecording) { mediaRecorder.stop(); logMessage("info", "Recording stopped."); }
    }
    function sendVoice() {
      if (!recordedVoice) { alert("No voice recording available to send."); return; }
      const user = firebase.auth().currentUser;
      if (!user) { logMessage("warning", "User attempted to send voice message without authentication."); alert(getTranslation('loginPrompt')); return; }
      const chatCode = catsData[currentChatIndex].code;
      const chatRef = firebase.database().ref(`/chats/${chatCode}/messages`).push();
      chatRef.set({ user: user.email, type: "voice", content: recordedVoice, timestamp: Date.now() }).then(() => {
        logMessage("info", "Voice message sent successfully.");
        alert("Voice message sent!");
        recordedVoice = null;
        document.getElementById("sendVoiceButton").style.display = "none";
        document.getElementById("reRecordButton").style.display = "none";
      }).catch(err => { logMessage("error", `Failed to send voice message: ${err}`); alert("Failed to send voice message."); });
    }
    function reRecordVoice() {
      recordedVoice = null;
      document.getElementById("sendVoiceButton").style.display = "none";
      document.getElementById("reRecordButton").style.display = "none";
      logMessage("info", "Voice recording cleared. Ready to re-record.");
    }
    function openManageQuestionsModal() {
      renderQuestionsList();
      document.getElementById("manageQuestionsModal").style.display = "flex";
    }
    function promoteUser(uid) {
      const user = firebase.auth().currentUser;
      if (!user) return;
      const isAdmin = catsData[currentChatIndex].members[user.uid].role === "admin";
      if (!isAdmin) return;
      catsData[currentChatIndex].members[uid].role = "admin";
      saveChatToDatabase(catsData[currentChatIndex]).then(() => { renderChatMembers(); logMessage("info", "User promoted to admin."); alert("User promoted to admin."); }).catch(err => { logMessage("error", `Failed to promote user: ${err}`); alert("Failed to promote user."); });
    }
    function demoteUser(uid) {
      const user = firebase.auth().currentUser;
      if (!user) return;
      const isAdmin = catsData[currentChatIndex].members[user.uid].role === "admin";
      if (!isAdmin) return;
      const admins = Object.values(catsData[currentChatIndex].members).filter(member => member.role === "admin");
      if (admins.length <= 1 && catsData[currentChatIndex].members[uid].role === "admin") { logMessage("warning", "Attempt to demote the last admin."); alert("There must be at least one admin for this chat."); return; }
      catsData[currentChatIndex].members[uid].role = "user";
      saveChatToDatabase(catsData[currentChatIndex]).then(() => { renderChatMembers(); logMessage("info", "User demoted to user."); alert("User demoted to user."); }).catch(err => { logMessage("error", `Failed to demote user: ${err}`); alert("Failed to demote user."); });
    }
    function exportChatExcel() {
      if (!catsData.length) return;
      const currentChat = catsData[currentChatIndex];
      const data = currentChat.history.map(entry => {
        const row = { Date: new Date(entry.timestamp).toLocaleDateString(), Time: new Date(entry.timestamp).toLocaleTimeString() };
        entry.answers.forEach((ans, i) => {
          const question = currentChat.form[i] ? currentChat.form[i].label : `Question ${i+1}`;
          if (typeof ans === "object") { row[question] = ans.value; if (ans.comment) { row[`${question} Comment`] = ans.comment; } }
          else { row[question] = ans; }
        });
        return row;
      });
      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Chat Data");
      XLSX.writeFile(workbook, `${currentChat.name}.xlsx`);
      logMessage("info", `Chat "${currentChat.name}" exported as Excel.`);
    }
    function showTutorial() {
      tutorialStep = 0;
      updateTutorialModal();
      document.getElementById("tutorialModal").style.display = "flex";
      logMessage("info", "Tutorial started.");
    }
    function nextTutorialStep() {
      if (tutorialStep < tutorialSteps[currentLanguage].length - 1) { tutorialStep++; updateTutorialModal(); }
      else { closeModal("tutorialModal"); logMessage("info", "Tutorial completed."); }
    }
    function updateTutorialModal() {
      document.getElementById("tutorialTitle").innerText = tutorialSteps[currentLanguage][tutorialStep].title;
      document.getElementById("tutorialText").innerText = tutorialSteps[currentLanguage][tutorialStep].text;
    }
    function checkShareURL(user) {
      const urlParams = new URLSearchParams(window.location.search);
      const shareCode = urlParams.get('share');
      if (shareCode) {
        const sharedChatRef = firebase.database().ref(`/chats/${shareCode}`);
        sharedChatRef.once('value').then(snapshot => {
          if (snapshot.exists()) {
            const sharedChat = snapshot.val();
            const existingIndex = catsData.findIndex(c => c.code === sharedChat.code);
            if (existingIndex === -1) {
              sharedChat.members = { ...sharedChat.members, [user.uid]: { email: user.email, role: "user" } };
              catsData.push(sharedChat);
              saveChatToDatabase(sharedChat).then(() => {
                renderChatSelector();
                selectChat();
                updateDeleteChatButton();
                renderQuestionsList();
                renderQuiz();
                renderRealtimeRadar();
                renderTimeSeriesChart();
                renderSummaryRadarChart();
                renderChat();
                renderCalendar();
                renderUpcomingEvents();
                logMessage("info", `Shared chat "${sharedChat.name}" added to user.`);
                alert("Shared chat added successfully!");
                const newURL = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, newURL);
              }).catch(err => { logMessage("error", `Failed to add shared chat: ${err}`); alert("Failed to add shared chat."); });
            } else { logMessage("warning", `Attempt to add already linked chat "${sharedChat.name}".`); alert("Chat is already linked."); }
          } else { logMessage("warning", `No shared chat found with code "${shareCode}".`); alert("No shared chat found with the provided code."); }
        }).catch(err => { logMessage("error", `Error retrieving shared chat: ${err}`); alert("Error retrieving shared chat."); });
      }
    }
    function renderChatMembers() {
      const user = firebase.auth().currentUser;
      if (!user) return;
      const chatCode = catsData[currentChatIndex].code;
      const members = catsData[currentChatIndex].members;
      const usersList = document.getElementById("usersList");
      usersList.innerHTML = '';
      for (const uid in members) {
        const member = members[uid];
        const li = document.createElement("li");
        li.innerHTML = `${member.email} - ${member.role === "admin" ? "Admin" : "User"}`;
        if (member.role !== "admin") {
          const promoteBtn = document.createElement("button");
          promoteBtn.textContent = getTranslation('promote');
          promoteBtn.onclick = () => promoteUser(uid);
          li.appendChild(promoteBtn);
        } else {
          if (uid !== user.uid) {
            const demoteBtn = document.createElement("button");
            demoteBtn.textContent = getTranslation('demote');
            demoteBtn.onclick = () => demoteUser(uid);
            li.appendChild(demoteBtn);
          }
        }
        usersList.appendChild(li);
      }
    }
    function linkExistingChat() {
      const shareCode = document.getElementById("linkChatCode").value.trim();
      if (!shareCode) { logMessage("warning", "No share code entered."); return; }
      const user = firebase.auth().currentUser;
      if (!user) { logMessage("warning", "User attempted to link chat without authentication."); alert(getTranslation('loginPrompt')); return; }
      const chatRef = firebase.database().ref(`/chats/${shareCode}`);
      chatRef.once('value').then(snapshot => {
        if (snapshot.exists()) {
          const sharedChat = snapshot.val();
          const existingIndex = catsData.findIndex(c => c.code === sharedChat.code);
          if (existingIndex === -1) {
            sharedChat.members = { ...sharedChat.members, [user.uid]: { email: user.email, role: "user" } };
            catsData.push(sharedChat);
            saveChatToDatabase(sharedChat).then(() => {
              renderChatSelector();
              selectChat();
              updateDeleteChatButton();
              renderQuestionsList();
              renderQuiz();
              renderRealtimeRadar();
              renderTimeSeriesChart();
              renderSummaryRadarChart();
              renderChat();
              renderCalendar();
              renderUpcomingEvents();
              logMessage("info", `Linked to shared chat "${sharedChat.name}".`);
              alert("Linked to shared chat successfully!");
              closeModal("linkChatModal");
            }).catch(err => { logMessage("error", `Failed to link shared chat: ${err}`); alert("Failed to link shared chat."); });
          } else { logMessage("warning", `Chat "${sharedChat.name}" is already linked.`); alert("Chat is already linked."); }
        } else { logMessage("warning", `No chat found with code "${shareCode}".`); alert("No chat found with the provided code."); }
      }).catch(err => { logMessage("error", `Error linking chat: ${err}`); alert("Error linking chat."); });
    }
    function renderQuestionsList() {
      const questionsList = document.getElementById("questionsList");
      questionsList.innerHTML = '';
      const form = catsData[currentChatIndex].form || forms["default"];
      form.forEach((q, index) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <span>${q.label} (${q.type})${q.type === 'slider' ? ` [${q.min} - ${q.max}]` : ''}${q.hasComment ? ' 🔍' : ''}</span>
          <div class="question-actions">
            <button onclick="editQuestion(${index})">${getTranslation('editQuestion')}</button>
            <button onclick="deleteQuestion(${index})">${getTranslation('deleteQuestion')}</button>
          </div>
        `;
        questionsList.appendChild(li);
      });
    }
    function openManageQuestionsModal() {
      renderQuestionsList();
      document.getElementById("manageQuestionsModal").style.display = "flex";
    }
    function togglePasswordVisibility(id) {
      const passwordInput = document.getElementById(id);
      passwordInput.type = passwordInput.type === "password" ? "text" : "password";
    }
    function updateModalTranslations() {
      const modals = document.querySelectorAll('.modal-content');
      modals.forEach(modal => {
        modal.querySelectorAll('[data-key]').forEach(element => {
          const key = element.getAttribute('data-key');
          if (languages[currentLanguage][key]) {
            if (element.tagName.toLowerCase() === 'input' || element.tagName.toLowerCase() === 'textarea') {
              element.placeholder = languages[currentLanguage][key];
            } else {
              element.textContent = languages[currentLanguage][key];
            }
          }
        });
      });
    }
    document.addEventListener('DOMContentLoaded', () => {
      const observer = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
          mutation.addedNodes.forEach(node => {
            if (node.classList && node.classList.contains('tooltip')) {
              const dayNumber = node.parentElement.textContent.trim();
              const today = new Date();
              const year = today.getFullYear();
              const month = today.getMonth();
              const day = parseInt(dayNumber, 10);
              const eventsForDay = catsData[currentChatIndex].calendar.filter(event => {
                const eventDate = new Date(event.date);
                return eventDate.getDate() === day && eventDate.getMonth() === month && eventDate.getFullYear() === year;
              });
              node.innerHTML = `
                <strong>Events:</strong><br>
                ${eventsForDay.map(event => `
                  <div class="tooltip-event" data-event-id="${event.id}">
                    <em>${event.title}</em>: ${event.description}
                    <div class="event-actions">
                      <button class="edit-event-btn">Edit</button>
                      <button class="delete-event-btn">Delete</button>
                    </div>
                  </div>
                `).join('<br>')}
              `;
            }
          });
        });
      });
      const calendarContainer = document.querySelector('.calendar-container');
      observer.observe(calendarContainer, { childList: true, subtree: true });
      calendarContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-event-btn')) {
          const eventId = e.target.closest('.tooltip-event').dataset.eventId;
          const event = catsData[currentChatIndex].calendar.find(ev => ev.id === eventId);
          if (event) {
            document.getElementById("editEventTitle").value = event.title;
            document.getElementById("editEventDateTime").value = new Date(event.date).toISOString().slice(0,16);
            document.getElementById("editEventDescription").value = event.description;
            document.getElementById("editEventModal").dataset.editEventId = eventId;
            document.getElementById("editEventModal").style.display = "flex";
          }
        }
        if (e.target.classList.contains('delete-event-btn')) {
          const eventId = e.target.closest('.tooltip-event').dataset.eventId;
          const event = catsData[currentChatIndex].calendar.find(ev => ev.id === eventId);
          if (event && confirm(`Are you sure you want to delete the event "${event.title}"?`)) {
            const index = catsData[currentChatIndex].calendar.findIndex(ev => ev.id === eventId);
            if (index !== -1) {
              catsData[currentChatIndex].calendar.splice(index, 1);
              saveChatToDatabase(catsData[currentChatIndex]).then(() => { renderCalendar(); logMessage("info", `Event "${event.title}" deleted successfully.`); alert("Event deleted successfully."); }).catch(err => { logMessage("error", `Failed to delete event: ${err}`); alert("Failed to delete event."); });
            }
          }
        }
      });
      window.saveEditedEvent = function() {
        const modal = document.getElementById("editEventModal");
        const eventId = modal.dataset.editEventId;
        const updatedTitle = document.getElementById("editEventTitle").value.trim();
        const updatedDateTime = document.getElementById("editEventDateTime").value;
        const updatedDescription = document.getElementById("editEventDescription").value.trim();
        if (!updatedTitle || !updatedDateTime) { alert("Event title and date/time are required."); return; }
        const updatedDate = new Date(updatedDateTime);
        if (isNaN(updatedDate.getTime())) { alert("Invalid date/time format."); return; }
        const event = catsData[currentChatIndex].calendar.find(ev => ev.id === eventId);
        if (event) {
          event.title = updatedTitle;
          event.date = updatedDate.toISOString();
          event.description = updatedDescription;
          saveChatToDatabase(catsData[currentChatIndex]).then(() => { renderCalendar(); closeModal("editEventModal"); logMessage("info", `Event "${updatedTitle}" edited successfully.`); alert("Event edited successfully!"); }).catch(err => { logMessage("error", `Failed to edit event: ${err}`); alert("Failed to edit event."); });
        }
      };
    });
    window.onload = () => {
      setTimeout(() => {
        document.getElementById("splash").classList.add("fade-out");
        setTimeout(() => { document.getElementById("splash").style.display = "none"; initializeFirebase(); }, 1000);
      }, 3000);
      renderUpcomingEvents();
    };
    function addEvent() {
      const title = document.getElementById("eventTitle").value.trim();
      const dateTime = document.getElementById("eventDateTime").value;
      const description = document.getElementById("eventDescription").value.trim();
      if (!title || !dateTime) { logMessage("warning", "No event title or date/time entered."); alert(getTranslation('errorOccurred')); return; }
      const eventDate = new Date(dateTime);
      if (isNaN(eventDate.getTime())) { logMessage("warning", "Invalid date/time entered."); alert(getTranslation('errorOccurred')); return; }
      const id = 'event-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      const event = { id, title, description, date: eventDate.toISOString() };
      catsData[currentChatIndex].calendar.push(event);
      saveChatToDatabase(catsData[currentChatIndex]).then(() => { renderCalendar(); closeModal("addEventModal"); logMessage("info", `Event "${title}" added to calendar.`); alert(getTranslation('eventAdded')); }).catch(err => { logMessage("error", `Failed to add event: ${err}`); alert(getTranslation('errorOccurred')); });
    }
  </script>
</body>
</html>
